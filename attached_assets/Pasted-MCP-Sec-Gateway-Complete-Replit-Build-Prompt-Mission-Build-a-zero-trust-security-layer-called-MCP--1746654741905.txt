MCPâ€‘Sec Gateway â€“ Complete Replit Build Prompt
Mission
Build a zeroâ€‘trust security layer called MCPâ€‘Sec Gateway that inspects and controls Model Context Protocol (MCP) traffic between AI agents (Claude, GPTâ€‘4, Mistral, etc.) and external tools.
It must implement the enforcement model, policy schema, audit format, and architecture described in the project docsARCHITECTUREPOLICY_SCHEMASECURITY_MODELAUDIT_LOG_FORMAT.

Core Requirements

Policy enforcement â€“ perâ€‘model tool allow/deny, active hours, call caps.

Schema validation â€“ JSONâ€‘Schema v7 on every tool input/output.

Rate limiting â€“ perâ€‘session & perâ€‘model, inâ€‘memory (no Redis).

Audit logging â€“ JSON lines exactly like AUDIT_LOG_FORMAT.md.

Dashboard â€“ /logs (JSON) and /dash (HTML) to view recent events.

Replit Constraints

Alwaysâ€‘on FastAPI server (Uvicorn) using the builtâ€‘in web view.

Secrets via Replit â€œSecretsâ€ tab or local .env (use pythonâ€‘dotenv).

No external Redis â†’ use Python dict with TTL for rate limiting.

File writes (logs) are fine; the Replit FS is persistent per repl.

Tech Stack

PythonÂ 3.11

FastAPI, Uvicorn, pyyaml, jsonschema, pydantic, pythonâ€‘dotenv

requirements.txt will list them so Replit autoâ€‘installs.

File / Module Layout

bash
Copy
Edit
.
â”œâ”€ main.py            # launches FastAPI app
â”œâ”€ gateway.py         # core request handler
â”œâ”€ policy_engine.py   # loads + enforces policies.yaml
â”œâ”€ schema_validator.py
â”œâ”€ rate_limiter.py
â”œâ”€ audit_logger.py
â”œâ”€ policies.yaml      # starter rules from docs
â”œâ”€ schemas/
â”‚   â””â”€ calendar.create_event.json
â”œâ”€ requirements.txt
â””â”€ .env.example       # sample env vars
System Flow
Prompt/ToolCall â†’ gateway.enforce() â†’ policy_engine â†’ rate_limiter â†’ schema_validator â†’ tool (if allowed) â†’ audit_logger

Detailed Tasks
1ï¸âƒ£â€¯gateway.py

FastAPI router with two POST endpoints:

/mcp/toolcall â€“ body: {model_id, session_id, tool_name, input}

/mcp/toolresult â€“ body: {model_id, session_id, tool_name, output}

Workflow per request:

policy_engine.check_policy(...)

rate_limiter.check_limit(...)

schema_validator.validate_input|output(...)

audit_logger.log_event({...}) (including latency)

Return structured JSON: {allowed, reason, status, result?}

2ï¸âƒ£â€¯policy_engine.py

Load policies.yaml at import. Structure must follow doc examplePOLICY_SCHEMA.

Function check_policy(model_id, tool_name, session_id) returns (allowed, reason).

Features: wildcards, active_hours, max_calls_per_session.

Provide reload_policies() and expose POST /reload in main.py.

3ï¸âƒ£â€¯schema_validator.py

Folder schemas/ holds individual tool schemas.

Functions validate_input(tool_name, payload) and validate_output(...).

Use jsonschema.validate; raise SchemaValidationError on failure.

4ï¸âƒ£â€¯rate_limiter.py

Global dict USAGE = {(model, session): {count:int, first_ts:float}}.

Enforce max_calls_per_session from the active policy.

Reset counters after 24â€¯h (TTL check). Raise RateLimitError on breach.

5ï¸âƒ£â€¯audit_logger.py

Global list LOG_HISTORY; append a dict for every event.

Write each dict as JSON line to audit.log and print() it.

Fields must match AUDIT_LOG_FORMAT.md (timestamp, ids, tool, payload, status, reason, latency).

6ï¸âƒ£â€¯main.py

Import FastAPI app from gateway.py.

Add:

GET /logs â€“ returns last 100 log entries (JSON).

GET /dash â€“ simple HTML/JS that fetches /logs and prettyâ€‘prints.

Include a demo @app.get("/") root route that says â€œMCPâ€‘Sec Gateway OKâ€.

Use if __name__ == "__main__": uvicorn.run(...) so Replitâ€™s Run button works.

7ï¸âƒ£â€¯policies.yaml (starter)

yaml
Copy
Edit
rules:
  - model: "gpt-4*"
    allow_tools: ["calendar.*", "search.*"]
    deny_tools: ["db.write*"]
    max_calls_per_session: 5
    active_hours: "08:00-18:00"
8ï¸âƒ£â€¯schemas/calendar.create_event.json (example)

json
Copy
Edit
{
  "type": "object",
  "required": ["title", "start_time"],
  "properties": {
    "title":      { "type": "string" },
    "start_time": { "type": "string", "format": "date-time" },
    "location":   { "type": "string" }
  }
}
9ï¸âƒ£â€¯requirements.txt

nginx
Copy
Edit
fastapi
uvicorn
pyyaml
jsonschema
pydantic
python-dotenv
ğŸ” .env.example

ini
Copy
Edit
LOG_LEVEL=info
POLICY_PATH=policies.yaml
Deliverables
Write every file above with clean, commented code so the project runs immediately in Replit after â€œRunâ€. Ensure the FastAPI server starts on $PORT